name: 🚀 Notificar eventos a Discord

on:
  push:
  pull_request:
  issues:
  release:
  fork:
  watch:

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: 📢 Enviar evento a Discord
        run: |
          EVENT_TYPE="${{ github.event_name }}"
          REPO="${{ github.repository }}"
          ACTOR="${{ github.actor }}"
          MESSAGE="${{ github.event.head_commit.message || 'Sin mensaje' }}"
          URL="${{ github.event.head_commit.url || github.event.repository.html_url }}"
          ROLE_ID="1319729041322016788"

          # Elegir emoji según el tipo de evento
          case "$EVENT_TYPE" in
            push)        ICON="📦"; TITLE="Nuevo *push* en el repositorio" ;;
            pull_request) ICON="🔀"; TITLE="Se creó o actualizó un *Pull Request*" ;;
            issues)      ICON="🐛"; TITLE="Actividad en *Issues*" ;;
            release)     ICON="🏷️"; TITLE="Nueva *Release* publicada" ;;
            fork)        ICON="🍴"; TITLE="Alguien hizo un *Fork* del repo" ;;
            watch)       ICON="⭐"; TITLE="Nuevo *Star* en el proyecto" ;;
            *)           ICON="📣"; TITLE="Nuevo evento detectado" ;;
          esac

          # Construir el payload JSON con jq
          PAYLOAD=$(jq -n \
            --arg title "$ICON $TITLE" \
            --arg type "$EVENT_TYPE" \
            --arg actor "$ACTOR" \
            --arg message "$MESSAGE" \
            --arg url "$URL" \
            --arg role "<@&${ROLE_ID}>" \
            --argjson color 5814783 \
            '{
              content: "🔔 **Notificación automática:** \($role)",
              allowed_mentions: { parse: ["roles"] },
              embeds: [
                {
                  title: $title,
                  description: (
                    "👤 **Autor:** " + $actor + "\n" +
                    "🧩 **Evento:** " + $type + "\n" +
                    "💬 **Mensaje:** " + $message
                  ),
                  url: $url,
                  color: $color,
                  footer: { text: "🤖 GitHub Actions • Enviado automáticamente" },
                  timestamp: (now | todate)
                }
              ]
            }')

          # Enviar el mensaje a Discord
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "$PAYLOAD" \
               "${{ secrets.DISCORD_WEBHOOK }}"
